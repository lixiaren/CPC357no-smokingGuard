<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Non-Smoking Guard | Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- 深色主题 CSS --- */
        body {
            background-color: #0f172a; 
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* 登录 */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #020617;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

    
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }
        .glass-card:hover {
            transform: translateY(-5px);
            border-color: #3b82f6;
        }

        /* 状态指示灯 */
        .status-badge {
            font-size: 1.2rem;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            display: inline-block;
            width: 100%;
            text-align: center;
        }
        .status-safe { background-color: #059669; color: white; box-shadow: 0 0 15px #059669; }
        .status-danger { background-color: #dc2626; color: white; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        /* 数据数值样式 */
        .data-value { font-size: 2.5rem; font-weight: bold; }
        .data-unit { font-size: 1rem; color: #94a3b8; }
        .data-label { color: #94a3b8; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        /* 顶部导航 */
        .navbar { background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid #334155; }
        .navbar-brand { font-weight: bold; color: #3b82f6 !important; }
        
        /* 表格样式 */
        .table-dark { background-color: transparent; }
        .table-dark td, .table-dark th { background-color: transparent; border-color: #334155; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="glass-card" style="width: 350px; text-align: center;">
            <i class="fas fa-shield-virus fa-3x mb-3 text-primary"></i>
            <h3 class="mb-4">Smart Guard Login</h3>
            <input type="text" id="username" class="form-control mb-3" placeholder="Username (admin)" style="background: #0f172a; border: 1px solid #334155; color: white;">
            <input type="password" id="password" class="form-control mb-4" placeholder="Password (1234)" style="background: #0f172a; border: 1px solid #334155; color: white;">
            <button onclick="login()" class="btn btn-primary w-100 fw-bold">ACCESS SYSTEM</button>
            <p id="login-error" class="text-danger mt-3" style="display: none;">Invalid Credentials</p>
        </div>
    </div>

    <div id="main-dashboard" style="display: none;">
        <nav class="navbar navbar-expand-lg navbar-dark mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><i class="fas fa-user-shield me-2"></i>SMART NON-SMOKING GUARD</a>
                <span class="navbar-text">
                    System Status: <span id="connection-status" class="badge bg-secondary">Connecting...</span>
                </span>
            </div>
        </nav>

        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <div class="glass-card text-center h-100 d-flex flex-column justify-content-center">
                        <div class="data-label mb-3">CURRENT STATUS</div>
                        <div id="system-status-badge" class="status-badge status-safe">
                            <i class="fas fa-check-circle me-2"></i>SECURE
                        </div>
                        <div id="detection-type" class="mt-3 text-warning fw-bold" style="min-height: 24px;"></div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="glass-card d-flex align-items-center justify-content-between p-3">
                                <div>
                                    <div class="data-label">TEMPERATURE</div>
                                    <div><span id="temp-val" class="data-value">--</span> <span class="data-unit">°C</span></div>
                                </div>
                                <i class="fas fa-thermometer-half fa-2x text-danger"></i>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="glass-card d-flex align-items-center justify-content-between p-3">
                                <div>
                                    <div class="data-label">HUMIDITY</div>
                                    <div><span id="hum-val" class="data-value">--</span> <span class="data-unit">%</span></div>
                                </div>
                                <i class="fas fa-tint fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="glass-card h-100">
                        <div id="gauge-chart" style="width: 100%; height: 200px;"></div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-lg-8">
                    <div class="glass-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0"><i class="fas fa-chart-line me-2 text-primary"></i>Real-time Smoke Level (Evidence)</h5>
                        
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary active btn-sm" onclick="changeTimeRange('24h', this)">24 Hours</button>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeTimeRange('7d', this)">7 Days</button>
                        </div>
                    </div>

                    <div id="line-chart" style="width: 100%; height: 300px;"></div>
               
                </div>

                <div class="col-lg-4">
                    <div class="glass-card" style="height: 385px; overflow-y: auto;">
                        <h5 class="mb-3"><i class="fas fa-history me-2 text-primary"></i>Violation Log</h5>
                        <table class="table table-dark table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Event</th>
                                    <th>Level</th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <script>
        // ================= 配置区域 =================
        // 前端使用 WebSocket 端口 
        // 公共 Broker 
        const MQTT_HOST = "broker.emqx.io"; 
        const MQTT_PORT = 8083; 
        const MQTT_TOPIC = "building/toilet/smoke_detector";
        // ===========================================

        let client;
        let gaugeChart, lineChart;
        let smokeData = []; // 存储折线图数据
        let timeData = [];  // 存储时间轴

        // 1. 登录逻辑
        function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u === 'admin' && p === '1234') {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-dashboard').style.display = 'block';
                initCharts(); // 初始化图表
                mqttConnect(); // 开始连接 MQTT
                loadHistoryFromDB();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        // 2. 初始化 ECharts 图表
        function initCharts() {
            // A. 仪表盘 (Gauge)
            gaugeChart = echarts.init(document.getElementById('gauge-chart'));
            const gaugeOption = {
                series: [{
                    type: 'gauge',
                    min: 0, max: 1305, // ESP32 模拟值范围
                    axisLine: {
                        lineStyle: {
                            width: 10,
                            color: [[0.3, '#059669'], [0.7, '#eab308'], [1, '#dc2626']]
                        }
                    },
                    pointer: { itemStyle: { color: 'auto' } },
                    detail: { valueAnimation: true, formatter: '{value}', color: 'auto', fontSize: 20 },
                    data: [{ value: 0, name: 'Smoke Level' }]
                }]
            };
            gaugeChart.setOption(gaugeOption);

            // B. 折线图 
            lineChart = echarts.init(document.getElementById('line-chart'));
            const lineOption = {
                grid: { top: 30, right: 20, bottom: 20, left: 40, containLabel: true },
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: timeData },
                yAxis: { type: 'value', min: 0, max: 1305 },
                series: [{
                    data: smokeData,
                    type: 'line',
                    smooth: true,
                    areaStyle: { color: 'rgba(59, 130, 246, 0.2)' },
                    lineStyle: { color: '#3b82f6' }
                }]
            };
            lineChart.setOption(lineOption);
            
            // 自适应窗口大小
            window.addEventListener('resize', function() {
                gaugeChart.resize();
                lineChart.resize();
            });
        }

        // 3. MQTT 连接逻辑
        function mqttConnect() {
            const clientId = "WebClient-" + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(MQTT_HOST, Number(MQTT_PORT), clientId);

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            client.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                useSSL: false 
            });
        }

        function onConnect() {
            console.log("MQTT Connected!");
            document.getElementById('connection-status').innerText = "Online";
            document.getElementById('connection-status').className = "badge bg-success";
            client.subscribe(MQTT_TOPIC);
        }

        function onFailure(responseObject) {
            console.log("Failed: " + responseObject.errorMessage);
            document.getElementById('connection-status').innerText = "Failed";
            document.getElementById('connection-status').className = "badge bg-danger";
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection Lost: " + responseObject.errorMessage);
                document.getElementById('connection-status').innerText = "Offline";
                document.getElementById('connection-status').className = "badge bg-secondary";
            }
        }

        // 4. 处理接收到的数据
        function onMessageArrived(message) {
            console.log("Received: " + message.payloadString);
            try {
                // 解析 JSON
                // 格式: {"temp":26.5, "hum":60.2, "smoke":2400, "status":"VIOLATION", "type":"Vaping", "alert":true}
                const data = JSON.parse(message.payloadString);
                
                updateDashboard(data);

            } catch(e) {
                console.error("JSON Parse Error", e);
            }
        }

       function updateDashboard(data) {
            // 更新左边的数字和仪表盘 
            document.getElementById('temp-val').innerText = data.temp;
            document.getElementById('hum-val').innerText = data.hum;
            gaugeChart.setOption({ series: [{ data: [{ value: data.smoke, name: 'Smoke' }] }] });

            //生成当前时间 
            const dateObj = new Date();
            let timeStr;
            
            if (currentRange === '7d') {
                // 7天
                timeStr = `${dateObj.getMonth()+1}/${dateObj.getDate()} ${dateObj.getHours()}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
            } else {
                // 24小时
                timeStr = dateObj.toLocaleTimeString();
            }
            
            
            timeData.push(timeStr);
            smokeData.push(data.smoke);
            
            
            if(timeData.length > 2000) { 
                timeData.shift(); 
                smokeData.shift(); 
            }

            // 刷新图表
            lineChart.setOption({ xAxis: { data: timeData }, series: [{ data: smokeData }] });

            // 状态与报警
            const statusBadge = document.getElementById('system-status-badge');
            const typeLabel = document.getElementById('detection-type');

            if (data.alert === true || data.status === "VIOLATION" || data.status === "VIOLATION DETECTED") {
                statusBadge.className = "status-badge status-danger";
                statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>VIOLATION';
                typeLabel.innerText = "TYPE: " + (data.type || "Unknown Smoke");
                
            
                if(!Swal.isVisible()) {
                    Swal.fire({
                        title: 'SMOKE DETECTED!',
                        text: `Violation Type: ${data.type} (Level: ${data.smoke})`,
                        icon: 'warning',
                        confirmButtonText: 'ACKNOWLEDGE',
                        background: '#1e293b',
                        color: '#fff'
                    });
                    addLog(data.type, data.smoke); 
                }
            } else {
                statusBadge.className = "status-badge status-safe";
                statusBadge.innerHTML = '<i class="fas fa-check-circle me-2"></i>SECURE';
                typeLabel.innerText = "";
            }
        }

        function addLog(event, level) {
            const tableBody = document.getElementById('log-table-body');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${new Date().toLocaleTimeString()}</td>
                <td class="text-danger fw-bold">${event}</td>
                <td>${level}</td>
            `;
          
            tableBody.insertBefore(row, tableBody.firstChild);
        }
      
let currentRange = '24h';

// 切换时间范围的函数
function changeTimeRange(range, btnElement) {
    currentRange = range;

   
    const buttons = btnElement.parentElement.children;
    for (let btn of buttons) {
        btn.classList.remove('active');
    }
   
    btnElement.classList.add('active');

  
    loadHistoryFromDB();
}

       // 从后端 API 加载数据 
        async function loadHistoryFromDB() {
            try {
                // 显示图表加载动画
                lineChart.showLoading({ text: 'Loading Data...', color: '#3b82f6', textColor: '#fff', maskColor: 'rgba(255, 255, 255, 0.1)' });

                // 1. 请求数据
                const response = await fetch(`http://localhost:3000/api/history?range=${currentRange}`);
                const data = await response.json();

                console.log(`收到 ${data.length} 条数据，正在更新图表和日志...`);

                // 2. 准备图表数据
                let newSmokeData = [];
                let newTimeData = [];
                
                // 3. 准备表格区域 
                const tableBody = document.getElementById('log-table-body');
                tableBody.innerHTML = ''; 

                // 4. 遍历数据
                data.forEach(record => {
                   
                    const dateObj = new Date(record.timestamp);
                    let timeStr;
                    
                    if (currentRange === '7d') {
                        
                        timeStr = `${dateObj.getMonth()+1}/${dateObj.getDate()} ${dateObj.getHours()}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
                    } else {
                       
                        timeStr = dateObj.toLocaleTimeString();
                    }

                    newTimeData.push(timeStr);
                    newSmokeData.push(record.smoke);
                });

              
                for (let i = data.length - 1; i >= 0; i--) {
                    const record = data[i];
                    
                   
                    if (record.alert === true || record.status.includes("VIOLATION")) {
                        
                        const dateObj = new Date(record.timestamp);
                        const row = document.createElement('tr');
                        
                        
                        row.innerHTML = `
                            <td>${dateObj.toLocaleString()}</td>
                            <td class="text-danger fw-bold">${record.type || 'Unknown'}</td>
                            <td>${record.smoke}</td>
                        `;
                        
                        tableBody.appendChild(row);
                    }
                }

             
                lineChart.setOption({
                    xAxis: { data: newTimeData },
                    series: [{ data: newSmokeData }]
                });

            
                timeData = newTimeData;
                smokeData = newSmokeData;

                lineChart.hideLoading();

            } catch (error) {
                console.error("加载失败:", error);
                lineChart.hideLoading();
               
            
            }
        }
    </script>
</body>
</html>